<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Contact Book</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>ðŸ“ž Contact Book App</h1>

        <div id="form-section">
            <h2>Add New Contact</h2>
            <form id="contact-form">
                <input type="hidden" id="contact-id">
                <input type="text" id="name" placeholder="Name" required>
                <input type="text" id="phone" placeholder="Phone Number" required>
                <input type="email" id="email" placeholder="Email (optional)">
                <input type="text" id="address" placeholder="Address (optional)">
                <button type="submit" id="submit-btn">Add Contact</button>
                <button type="button" id="cancel-btn" style="display: none;">Cancel Edit</button>
            </form>
        </div>

        <hr>

        <div id="list-section">
            <h2>Contact List</h2>
            <input type="text" id="search-input" placeholder="Search by Name or Phone..." onkeyup="searchContacts()">
            <ul id="contact-list">
                </ul>
        </div>
    </div>

    <script>
        // --- Core Functions ---

        // Fetches contacts from the backend and renders them
        async function fetchAndRenderContacts() {
            try {
                const response = await fetch('/api/contacts');
                const contacts = await response.json();
                renderContactList(contacts);
            } catch (error) {
                console.error('Error fetching contacts:', error);
            }
        }

        // Renders the list of contacts in the UL
        function renderContactList(contacts) {
            const list = document.getElementById('contact-list');
            list.innerHTML = ''; 
            
            contacts.forEach(contact => {
                const li = document.createElement('li');
                
                // Use default values for optional fields if they are missing
                const email = contact.email || 'N/A';
                const address = contact.address || 'N/A';

                li.innerHTML = `
                    <div class="contact-info">
                        <strong>${contact.name}</strong> (${contact.phone})
                        <span class="details" style="display:none;">
                            <br>Email: ${email}
                            <br>Address: ${address}
                        </span>
                    </div>
                    <div class="actions">
                        <button onclick="viewDetails(this)">View Details</button>
                        <button onclick="editContact(${contact.id}, '${contact.name}', '${contact.phone}', '${email}', '${address}')">Edit</button>
                        <button class="delete-btn" onclick="deleteContact(${contact.id})">Delete</button>
                    </div>
                `;
                // Data attributes for Search Contact functionality
                li.setAttribute('data-name', contact.name.toLowerCase());
                li.setAttribute('data-phone', contact.phone);
                list.appendChild(li);
            });
        }
        
        // Toggles visibility of full contact details
        function viewDetails(button) {
            const detailsSpan = button.closest('li').querySelector('.details');
            if (detailsSpan.style.display === 'none') {
                detailsSpan.style.display = 'block';
                button.textContent = 'Hide Details';
            } else {
                detailsSpan.style.display = 'none';
                button.textContent = 'View Details';
            }
        }

        // Search Contact functionality
        function searchContacts() {
            const input = document.getElementById('search-input').value.toLowerCase();
            const list = document.getElementById('contact-list');
            const contacts = list.getElementsByTagName('li');

            for (let i = 0; i < contacts.length; i++) {
                const name = contacts[i].getAttribute('data-name');
                const phone = contacts[i].getAttribute('data-phone');
                
                // Show contact if name or phone matches search input
                if (name.includes(input) || phone.includes(input)) {
                    contacts[i].style.display = "flex"; // Use flex to maintain layout
                } else {
                    contacts[i].style.display = "none";
                }
            }
        }
        
        // --- Form Handling & CRUD Operations ---
        
        // Handles form submission (Add Contact / Update Contact)
        document.getElementById('contact-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const contactId = document.getElementById('contact-id').value;
            const contactData = { 
                name: document.getElementById('name').value, 
                phone: document.getElementById('phone').value, 
                email: document.getElementById('email').value, 
                address: document.getElementById('address').value 
            };

            const method = contactId ? 'PUT' : 'POST';
            const url = contactId ? `/api/contacts/${contactId}` : '/api/contacts';

            await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(contactData)
            });
            
            // Reset form and refresh list
            resetForm();
            fetchAndRenderContacts();
        });
        
        // Populates the form fields for editing (Update Contact)
        function editContact(id, name, phone, email, address) {
            document.getElementById('contact-id').value = id;
            document.getElementById('name').value = name;
            document.getElementById('phone').value = phone;
            document.getElementById('email').value = email === 'N/A' ? '' : email;
            document.getElementById('address').value = address === 'N/A' ? '' : address;
            
            // Change form mode to "Edit"
            document.getElementById('submit-btn').textContent = 'Update Contact';
            document.getElementById('cancel-btn').style.display = 'inline-block';
            document.querySelector('#form-section h2').textContent = 'Edit Contact';
            window.scrollTo(0, 0); // Scroll to the form
        }
        
        // Helper function to reset the form to 'Add' mode
        function resetForm() {
            document.getElementById('contact-form').reset();
            document.getElementById('contact-id').value = '';
            document.getElementById('submit-btn').textContent = 'Add Contact';
            document.getElementById('cancel-btn').style.display = 'none';
            document.querySelector('#form-section h2').textContent = 'Add New Contact';
        }

        // Cancel Edit button action
        document.getElementById('cancel-btn').addEventListener('click', resetForm);

        // Deletes a contact
        async function deleteContact(id) {
            if (confirm('Are you sure you want to delete this contact?')) {
                await fetch(`/api/contacts/${id}`, {
                    method: 'DELETE'
                });
                fetchAndRenderContacts();
            }
        }

        // Initial load of contacts when the page loads
        document.addEventListener('DOMContentLoaded', fetchAndRenderContacts);
    </script>
</body>
</html>